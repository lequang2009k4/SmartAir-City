<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test External MQTT Broker</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 900px;
        margin: 40px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }
      h2 {
        color: #34495e;
        margin-top: 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }
      input,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box;
      }
      input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
      }
      .checkbox-group {
        display: flex;
        align-items: center;
      }
      button {
        background: #3498db;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-right: 10px;
      }
      button:hover {
        background: #2980b9;
      }
      button.secondary {
        background: #95a5a6;
      }
      button.secondary:hover {
        background: #7f8c8d;
      }
      button.danger {
        background: #e74c3c;
      }
      button.danger:hover {
        background: #c0392b;
      }
      .response {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        white-space: pre-wrap;
        font-family: "Courier New", monospace;
        font-size: 13px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      #sourcesList {
        margin-top: 20px;
      }
      .source-item {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        border-left: 4px solid #3498db;
      }
      .source-item.inactive {
        border-left-color: #95a5a6;
        opacity: 0.7;
      }
      .source-item h3 {
        margin: 0 0 10px 0;
        color: #2c3e50;
      }
      .source-item p {
        margin: 5px 0;
        color: #555;
      }
      .source-actions {
        margin-top: 10px;
      }
      .source-actions button {
        padding: 8px 15px;
        font-size: 14px;
      }
      .realtime-data {
        margin-top: 30px;
        padding: 20px;
        background: #ecf0f1;
        border-radius: 5px;
      }
      .data-item {
        background: white;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        border-left: 3px solid #27ae60;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üåê Test External MQTT Broker</h1>
      <p>
        ƒêƒÉng k√Ω MQTT broker c·ªßa b·∫°n ƒë·ªÉ ƒë√≥ng g√≥p d·ªØ li·ªáu ch·∫•t l∆∞·ª£ng kh√¥ng kh√≠
      </p>

      <h2>üìù ƒêƒÉng k√Ω MQTT Broker m·ªõi</h2>
      <div class="form-group">
        <label>T√™n ngu·ªìn d·ªØ li·ªáu:</label>
        <input
          type="text"
          id="name"
          placeholder="VD: My Home Sensor Station"
          value="Hanoi HODH Park Sensor"
        />
        <small style="color: #666; display: block; margin-top: 5px"
          >üìå Station ID s·∫Ω t·ª± ƒë·ªông t·∫°o t·ª´ t√™n n√†y</small
        >
      </div>

      <div class="form-group">
        <label>Broker Host/IP:</label>
        <input
          type="text"
          id="brokerHost"
          placeholder="VD: broker.hivemq.com ho·∫∑c 192.168.1.100"
          value="16.176.23.226"
        />
      </div>

      <div class="form-group">
        <label>Port:</label>
        <input
          type="number"
          id="brokerPort"
          placeholder="1883 (kh√¥ng TLS) ho·∫∑c 8883 (TLS)"
          value="1883"
        />
      </div>

      <div class="form-group">
        <label>Username:</label>
        <input
          type="text"
          id="username"
          placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c·∫ßn"
          value="iotuser"
        />
      </div>

      <div class="form-group">
        <label>Password:</label>
        <input
          type="password"
          id="password"
          placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c·∫ßn"
          value="123456"
        />
      </div>

      <div class="form-group checkbox-group">
        <input type="checkbox" id="useTls" />
        <label for="useTls">S·ª≠ d·ª•ng TLS/SSL (kh√¥ng tick cho port 1883)</label>
      </div>

      <div class="form-group">
        <label>Topic:</label>
        <input
          type="text"
          id="topic"
          placeholder="VD: sensors/airquality/#"
          value="air/quality/hanoi/congvien-hodh"
        />
      </div>

      <div class="form-group">
        <label>Latitude (vƒ© ƒë·ªô):</label>
        <input
          type="number"
          step="0.000001"
          id="latitude"
          placeholder="VD: 21.028511"
          value="21.028511"
        />
      </div>

      <div class="form-group">
        <label>Longitude (kinh ƒë·ªô):</label>
        <input
          type="number"
          step="0.000001"
          id="longitude"
          placeholder="VD: 105.804817"
          value="105.804817"
        />
      </div>

      <button onclick="createSource()">‚úÖ ƒêƒÉng k√Ω Broker</button>
      <button class="secondary" onclick="testConnection()">
        üîå Test Connection
      </button>
      <button class="secondary" onclick="loadSources()">üîÑ Refresh List</button>

      <div id="response"></div>

      <h2>üìã Danh s√°ch MQTT Sources</h2>
      <div id="sourcesList"></div>

      <h2>üì° Real-time Data (SignalR)</h2>
      <button onclick="connectSignalR()">üîó Connect to SignalR</button>
      <button class="danger" onclick="disconnectSignalR()">
        ‚ùå Disconnect
      </button>
      <div class="realtime-data">
        <div id="signalrStatus">Ch∆∞a k·∫øt n·ªëi</div>
        <div id="realtimeData"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <script>
      // T·ª± ƒë·ªông l·∫•y URL hi·ªán t·∫°i ƒë·ªÉ kh√¥ng b·ªã sai port
      const API_BASE = `${window.location.protocol}//${window.location.host}/api/mqtt`;
      const SIGNALR_URL = `${window.location.protocol}//${window.location.host}/airqualityhub`;
      let connection = null;

      // T·∫°o source m·ªõi
      async function createSource() {
        const source = {
          name: document.getElementById("name").value,
          brokerHost: document.getElementById("brokerHost").value,
          brokerPort: parseInt(document.getElementById("brokerPort").value),
          username: document.getElementById("username").value || null,
          password: document.getElementById("password").value || null,
          useTls: document.getElementById("useTls").checked,
          topic: document.getElementById("topic").value,
          latitude: parseFloat(document.getElementById("latitude").value),
          longitude: parseFloat(document.getElementById("longitude").value),
        };

        try {
          const response = await fetch(`${API_BASE}/sources`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(source),
          });

          const text = await response.text();
          let data;
          try {
            data = text ? JSON.parse(text) : {};
          } catch {
            data = { message: text };
          }

          if (response.ok) {
            showResponse(
              "success",
              "‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng!\n\n" + JSON.stringify(data, null, 2)
            );
            loadSources();
          } else {
            showResponse(
              "error",
              `‚ùå L·ªói (HTTP ${response.status}):\n${JSON.stringify(
                data,
                null,
                2
              )}\n\nResponse text: ${text}`
            );
          }
        } catch (error) {
          showResponse("error", "‚ùå L·ªói k·∫øt n·ªëi: " + error.message);
        }
      }

      // Test connection
      async function testConnection() {
        const testData = {
          brokerHost: document.getElementById("brokerHost").value,
          brokerPort: parseInt(document.getElementById("brokerPort").value),
          username: document.getElementById("username").value || null,
          password: document.getElementById("password").value || null,
          useTls: document.getElementById("useTls").checked,
          topic: document.getElementById("topic").value,
        };

        try {
          const response = await fetch(`${API_BASE}/sources/test`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testData),
          });

          const text = await response.text();
          let data;
          try {
            data = text ? JSON.parse(text) : {};
          } catch {
            data = { message: text };
          }

          if (response.ok) {
            showResponse(
              "success",
              "‚úÖ Test th√†nh c√¥ng!\n\n" + JSON.stringify(data, null, 2)
            );
          } else {
            showResponse(
              "error",
              "‚ùå Test th·∫•t b·∫°i: " + JSON.stringify(data, null, 2)
            );
          }
        } catch (error) {
          showResponse("error", "‚ùå L·ªói test: " + error.message);
        }
      }

      // Load danh s√°ch sources
      async function loadSources() {
        try {
          const response = await fetch(`${API_BASE}/sources`);
          const sources = await response.json();

          const listHtml = sources
            .map(
              (s) => `
                    <div class="source-item ${s.isActive ? "" : "inactive"}">
                        <h3>${s.name} ${s.isActive ? "üü¢" : "üî¥"}</h3>
                        <p><strong>Broker:</strong> ${s.brokerHost}:${
                s.brokerPort
              } ${s.useTls ? "(TLS)" : ""}</p>
                        <p><strong>Topic:</strong> ${s.topic}</p>
                        <p><strong>Location:</strong> ${s.latitude}, ${
                s.longitude
              }</p>
                        <p><strong>Messages:</strong> ${s.messageCount || 0}</p>
                        <p><strong>Last Message:</strong> ${
                          s.lastMessageAt
                            ? new Date(s.lastMessageAt).toLocaleString()
                            : "Ch∆∞a c√≥"
                        }</p>
                        ${
                          s.lastError
                            ? `<p style="color: red;"><strong>Error:</strong> ${s.lastError}</p>`
                            : ""
                        }
                        <div class="source-actions">
                            ${
                              s.isActive
                                ? `<button class="secondary" onclick="deactivateSource('${s.id}')">‚è∏Ô∏è Deactivate</button>`
                                : `<button onclick="activateSource('${s.id}')">‚ñ∂Ô∏è Activate</button>`
                            }
                            <button class="danger" onclick="deleteSource('${
                              s.id
                            }')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `
            )
            .join("");

          document.getElementById("sourcesList").innerHTML =
            listHtml || "<p>Ch∆∞a c√≥ source n√†o</p>";
        } catch (error) {
          showResponse("error", "‚ùå L·ªói load sources: " + error.message);
        }
      }

      // Activate source
      async function activateSource(id) {
        try {
          const response = await fetch(`${API_BASE}/sources/${id}/activate`, {
            method: "POST",
          });
          const data = await response.json();
          showResponse(
            "success",
            "‚úÖ Activated: " + JSON.stringify(data, null, 2)
          );
          loadSources();
        } catch (error) {
          showResponse("error", "‚ùå L·ªói activate: " + error.message);
        }
      }

      // Deactivate source
      async function deactivateSource(id) {
        try {
          const response = await fetch(`${API_BASE}/sources/${id}/deactivate`, {
            method: "POST",
          });
          const data = await response.json();
          showResponse(
            "success",
            "‚è∏Ô∏è Deactivated: " + JSON.stringify(data, null, 2)
          );
          loadSources();
        } catch (error) {
          showResponse("error", "‚ùå L·ªói deactivate: " + error.message);
        }
      }

      // Delete source
      async function deleteSource(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a source n√†y?")) return;

        try {
          await fetch(`${API_BASE}/sources/${id}`, { method: "DELETE" });
          showResponse("success", "üóëÔ∏è ƒê√£ x√≥a source");
          loadSources();
        } catch (error) {
          showResponse("error", "‚ùå L·ªói x√≥a: " + error.message);
        }
      }

      // SignalR Connection
      function connectSignalR() {
        connection = new signalR.HubConnectionBuilder()
          .withUrl(SIGNALR_URL)
          .withAutomaticReconnect()
          .build();

        connection.on("ReceiveAirQualityUpdate", (data) => {
          const dataDiv = document.getElementById("realtimeData");
          const item = document.createElement("div");
          item.className = "data-item";
          item.innerHTML = `
                    <strong>${new Date().toLocaleTimeString()}</strong> - ${
            data.id
          }<br>
                    Station: ${data.stationId || "N/A"}<br>
                    Location: ${data.location?.coordinates || "N/A"}<br>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
          dataDiv.insertBefore(item, dataDiv.firstChild);

          // Gi·ªØ t·ªëi ƒëa 10 items
          while (dataDiv.children.length > 10) {
            dataDiv.removeChild(dataDiv.lastChild);
          }
        });

        connection
          .start()
          .then(() => {
            document.getElementById("signalrStatus").innerHTML =
              "üü¢ ƒê√£ k·∫øt n·ªëi SignalR";
            showResponse("success", "‚úÖ SignalR connected");
          })
          .catch((err) => {
            document.getElementById("signalrStatus").innerHTML =
              "üî¥ L·ªói k·∫øt n·ªëi";
            showResponse("error", "‚ùå SignalR error: " + err);
          });
      }

      function disconnectSignalR() {
        if (connection) {
          connection.stop();
          document.getElementById("signalrStatus").innerHTML =
            "‚ö´ ƒê√£ ng·∫Øt k·∫øt n·ªëi";
          showResponse("info", "‚ÑπÔ∏è SignalR disconnected");
        }
      }

      // Helper
      function showResponse(type, message) {
        const div = document.getElementById("response");
        div.className = `response ${type}`;
        div.textContent = message;
      }

      // Load sources and auto-connect SignalR on page load
      window.onload = function () {
        loadSources();
        connectSignalR(); // Auto-connect SignalR
      };
    </script>
  </body>
</html>
