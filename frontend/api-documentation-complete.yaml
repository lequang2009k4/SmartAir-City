openapi: 3.0.3
info:
  title: SmartAir City - Complete API Documentation (Public + Hidden)
  version: 1.0.0
  description: |
    üåç **Complete API Documentation for SmartAir City**
    
    This document includes **ALL** endpoints - both public and hidden.
    
    ## API Visibility Legend
    
    - ‚úÖ **PUBLIC**: Visible in Swagger UI (7 endpoints)
    - üîí **HIDDEN**: Hidden from Swagger but functional (35+ endpoints)
    
    ---
    
    ## Public APIs (Visible in Swagger)
    
    1. **Air Quality** (5 endpoints)
       - GET /api/airquality
       - GET /api/airquality/latest
       - GET /api/airquality/history
       - GET /api/airquality/download
       - GET /api/airquality/history/download
    
    2. **Stations** (1 endpoint)
       - GET /api/stations (returns NGSI-LD Device entities)
    
    ---
    
    ## Hidden APIs (Still Functional)
    
    All hidden APIs work but are not shown in Swagger UI.
    They can still be accessed directly via HTTP requests.
    
    **Implementation:** Using `[ApiExplorerSettings(IgnoreApi = true)]`
    
    ---
    
    ## üìä Data Format
    
    All public APIs return **NGSI-LD format** following:
    - ETSI NGSI-LD specification
    - FIWARE Smart Data Models
    
    ---
    
    ## üîì Licenses
    
    - **Data**: CC BY 4.0
    - **Code**: MIT License
    
  contact:
    name: SmartAir City Development Team
    email: smartaircity@gmail.com
    url: https://github.com/lequang2009k4/SmartAir-City
  license:
    name: 'Data: CC BY 4.0 | Code: MIT'
    url: https://creativecommons.org/licenses/by/4.0/

servers:
  - url: http://localhost:51872
    description: Local development server

tags:
  - name: ‚úÖ Air Quality (Public)
    description: Public air quality data endpoints (NGSI-LD format)
  - name: ‚úÖ Stations (Public)
    description: Public station information (NGSI-LD Device format)
  - name: üîí Stations (Hidden)
    description: Hidden station management endpoints
  - name: üîí Contributions (Hidden)
    description: Hidden citizen contribution endpoints (entire controller)
  - name: üîí External HTTP (Hidden)
    description: Hidden external HTTP source management (entire controller)
  - name: üîí External MQTT (Hidden)
    description: Hidden external MQTT source management (entire controller)

paths:
  # ============================================
  # ‚úÖ PUBLIC: AIR QUALITY ENDPOINTS
  # ============================================
  
  /api/airquality:
    get:
      tags:
        - ‚úÖ Air Quality (Public)
      summary: ‚úÖ PUBLIC - Get air quality observations
      description: |
        **Status: PUBLIC** (Visible in Swagger)
        
        Retrieve NGSI-LD air quality observations for a specific station.
        Returns AirQualityObserved entities following FIWARE standards.
      operationId: getAirQuality
      parameters:
        - name: stationId
          in: query
          required: true
          schema:
            type: string
            example: "station-nguyenvancu"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
      responses:
        '200':
          description: NGSI-LD AirQualityObserved entities
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NgsiLdAirQuality'

  /api/airquality/latest:
    get:
      tags:
        - ‚úÖ Air Quality (Public)
      summary: ‚úÖ PUBLIC - Get latest air quality observation
      description: |
        **Status: PUBLIC** (Visible in Swagger)
      operationId: getLatestAirQuality
      parameters:
        - name: stationId
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Latest observation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NgsiLdAirQuality'

  /api/airquality/history:
    get:
      tags:
        - ‚úÖ Air Quality (Public)
      summary: ‚úÖ PUBLIC - Get historical air quality data
      description: |
        **Status: PUBLIC** (Visible in Swagger)
      operationId: getAirQualityHistory
      parameters:
        - name: stationId
          in: query
          required: true
          schema:
            type: string
        - name: from
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          required: true
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Historical data
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NgsiLdAirQuality'

  /api/airquality/download:
    get:
      tags:
        - ‚úÖ Air Quality (Public)
      summary: ‚úÖ PUBLIC - Download air quality data
      description: |
        **Status: PUBLIC** (Visible in Swagger)
      operationId: downloadAirQuality
      parameters:
        - name: stationId
          in: query
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: format
          in: query
          schema:
            type: string
            enum: [json]
            default: json
      responses:
        '200':
          description: JSON file download

  /api/airquality/history/download:
    get:
      tags:
        - ‚úÖ Air Quality (Public)
      summary: ‚úÖ PUBLIC - Download historical data
      description: |
        **Status: PUBLIC** (Visible in Swagger)
      operationId: downloadAirQualityHistory
      parameters:
        - name: stationId
          in: query
          required: true
          schema:
            type: string
        - name: from
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: format
          in: query
          schema:
            type: string
            enum: [json]
            default: json
      responses:
        '200':
          description: JSON file download

  # ============================================
  # ‚úÖ PUBLIC: STATIONS ENDPOINT
  # ============================================
  
  /api/stations:
    get:
      tags:
        - ‚úÖ Stations (Public)
      summary: ‚úÖ PUBLIC - Get all monitoring stations
      description: |
        **Status: PUBLIC** (Visible in Swagger)
        
        **IMPORTANT CHANGE:** Now returns NGSI-LD Device format (not simple JSON)
        
        Returns array of Device entities following FIWARE Smart Data Models.
        - No metadata field exposed
        - No MongoDB _id exposed
        - GeoJSON coordinates [lon, lat]
        - controlledProperty: "airPollution"
      operationId: getStations
      responses:
        '200':
          description: NGSI-LD Device entities
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NgsiLdDevice'
              example:
                - "@context":
                    - "https://smartdatamodels.org/context.jsonld"
                    - sosa: "http://www.w3.org/ns/sosa/"
                  id: "urn:ngsi-ld:Device:station-nguyenvancu"
                  type: "Device"
                  name:
                    type: "Property"
                    value: "Nguyenvancu"
                  location:
                    type: "GeoProperty"
                    value:
                      type: "Point"
                      coordinates: [105.883102, 21.049101]
                  deviceState:
                    type: "Property"
                    value: "active"
                  deviceCategory:
                    type: "Property"
                    value: ["sensor"]
                  controlledProperty:
                    type: "Property"
                    value: ["airPollution"]
    
    post:
      tags:
        - üîí Stations (Hidden)
      summary: üîí HIDDEN - Create new station
      description: |
        **Status: HIDDEN** from Swagger UI
        
        Implementation: `[ApiExplorerSettings(IgnoreApi = true)]`
        
        Register a new monitoring station in the system.
      operationId: createStation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Station'
            example:
              stationId: "station-test"
              name: "Test Station"
              latitude: 21.028511
              longitude: 105.804817
              type: "iot"
              isActive: true
      responses:
        '201':
          description: Station created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Station'
        '400':
          description: Invalid station data (missing stationId or name)
        '409':
          description: Station already exists

  # ============================================
  # üîí HIDDEN: STATION MANAGEMENT
  # ============================================
  
  /api/stations/{stationId}:
    get:
      tags:
        - üîí Stations (Hidden)
      summary: üîí HIDDEN - Get specific station
      description: |
        **Status: HIDDEN** from Swagger UI
        
        Implementation: `[ApiExplorerSettings(IgnoreApi = true)]`
        
        Still functional via direct HTTP GET request.
      operationId: getStation
      parameters:
        - name: stationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Station details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Station'
    
    put:
      tags:
        - üîí Stations (Hidden)
      summary: üîí HIDDEN - Update station
      description: |
        **Status: HIDDEN** from Swagger UI
        
        Implementation: `[ApiExplorerSettings(IgnoreApi = true)]`
      operationId: updateStation
      parameters:
        - name: stationId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Station'
      responses:
        '200':
          description: Updated
    
    delete:
      tags:
        - üîí Stations (Hidden)
      summary: üîí HIDDEN - Delete station
      description: |
        **Status: HIDDEN** from Swagger UI
        
        Implementation: `[ApiExplorerSettings(IgnoreApi = true)]`
      operationId: deleteStation
      parameters:
        - name: stationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Deleted
  
  /api/stations/map:
    get:
      tags:
        - üîí Stations (Hidden)
      summary: üîí HIDDEN - Get stations for map
      description: |
        **Status: HIDDEN** from Swagger UI
        
        Implementation: `[ApiExplorerSettings(IgnoreApi = true)]`
      operationId: getStationsForMap
      responses:
        '200':
          description: Minimal station data

  # ============================================
  # üîí HIDDEN: CONTRIBUTIONS (Entire Controller)
  # ============================================
  
  /api/contributions/upload:
    post:
      tags:
        - üîí Contributions (Hidden)
      summary: üîí HIDDEN - Upload contribution
      description: |
        **Status: HIDDEN** from Swagger UI
        
        Implementation: `[ApiExplorerSettings(IgnoreApi = true)]` at controller level
        
        Entire ContributionController is hidden.
      operationId: uploadContribution
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Uploaded
  
  /api/contributions/public:
    get:
      tags:
        - üîí Contributions (Hidden)
      summary: üîí HIDDEN - Get public contributors
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: getPublicContributions
      responses:
        '200':
          description: Contributors list
  
  /api/contributions/list:
    get:
      tags:
        - üîí Contributions (Hidden)
      summary: üîí HIDDEN - Get contribution list
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: getContributionIds
      parameters:
        - name: email
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Contribution list
  
  /api/contributions/{contributionId}/latest:
    get:
      tags:
        - üîí Contributions (Hidden)
      summary: üîí HIDDEN - Get latest contribution data
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: getLatestByContributionId
      parameters:
        - name: contributionId
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 5
      responses:
        '200':
          description: Latest records
  
  /api/contributions/{contributionId}/download:
    get:
      tags:
        - üîí Contributions (Hidden)
      summary: üîí HIDDEN - Download contribution
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: downloadByContributionId
      parameters:
        - name: contributionId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: File download

  # ============================================
  # üîí HIDDEN: EXTERNAL HTTP SOURCES (Entire Controller)
  # ============================================
  
  /api/sources:
    get:
      tags:
        - üîí External HTTP (Hidden)
      summary: üîí HIDDEN - Get all external sources
      description: |
        **Status: HIDDEN** from Swagger UI
        
        Implementation: `[ApiExplorerSettings(IgnoreApi = true)]` at controller level
      operationId: getAllSources
      responses:
        '200':
          description: Source list
    
    post:
      tags:
        - üîí External HTTP (Hidden)
      summary: üîí HIDDEN - Create external source
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: createSource
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExternalSource'
      responses:
        '201':
          description: Created
  
  /api/sources/{id}:
    delete:
      tags:
        - üîí External HTTP (Hidden)
      summary: üîí HIDDEN - Delete source
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: deleteSource
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Deleted
  
  /api/sources/{id}/reactivate:
    post:
      tags:
        - üîí External HTTP (Hidden)
      summary: üîí HIDDEN - Reactivate source
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: reactivateSource
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Reactivated
  
  /api/sources/test:
    post:
      tags:
        - üîí External HTTP (Hidden)
      summary: üîí HIDDEN - Test source URL
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: testSourceUrl
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
      responses:
        '200':
          description: Test result

  # ============================================
  # üîí HIDDEN: EXTERNAL MQTT (Entire Controller)
  # ============================================
  
  /api/mqtt/sources:
    get:
      tags:
        - üîí External MQTT (Hidden)
      summary: üîí HIDDEN - Get all MQTT sources
      description: |
        **Status: HIDDEN** from Swagger UI
        
        Implementation: `[ApiExplorerSettings(IgnoreApi = true)]` at controller level
      operationId: getAllMqttSources
      responses:
        '200':
          description: MQTT source list
    
    post:
      tags:
        - üîí External MQTT (Hidden)
      summary: üîí HIDDEN - Create MQTT source
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: createMqttSource
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExternalMqttSource'
      responses:
        '201':
          description: Created
  
  /api/mqtt/sources/{id}:
    get:
      tags:
        - üîí External MQTT (Hidden)
      summary: üîí HIDDEN - Get MQTT source
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: getMqttSource
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Source details
    
    put:
      tags:
        - üîí External MQTT (Hidden)
      summary: üîí HIDDEN - Update MQTT source
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: updateMqttSource
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExternalMqttSource'
      responses:
        '200':
          description: Updated
    
    delete:
      tags:
        - üîí External MQTT (Hidden)
      summary: üîí HIDDEN - Delete MQTT source
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: deleteMqttSource
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted
  
  /api/mqtt/sources/{id}/openaq:
    patch:
      tags:
        - üîí External MQTT (Hidden)
      summary: üîí HIDDEN - Update OpenAQ ID
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: updateMqttSourceOpenAQ
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                openAQLocationId:
                  type: integer
      responses:
        '200':
          description: Updated
  
  /api/mqtt/sources/{id}/activate:
    post:
      tags:
        - üîí External MQTT (Hidden)
      summary: üîí HIDDEN - Activate source
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: activateMqttSource
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Activated
  
  /api/mqtt/sources/{id}/deactivate:
    post:
      tags:
        - üîí External MQTT (Hidden)
      summary: üîí HIDDEN - Deactivate source
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: deactivateMqttSource
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Deactivated
  
  /api/mqtt/sources/test:
    post:
      tags:
        - üîí External MQTT (Hidden)
      summary: üîí HIDDEN - Test MQTT connection
      description: |
        **Status: HIDDEN** from Swagger UI
      operationId: testMqttConnection
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                brokerHost:
                  type: string
                brokerPort:
                  type: integer
                username:
                  type: string
                password:
                  type: string
                topic:
                  type: string
      responses:
        '200':
          description: Test result

# ============================================
# SCHEMAS
# ============================================

components:
  schemas:
    NgsiLdDevice:
      type: object
      description: |
        **NGSI-LD Device Entity** for monitoring stations
        
        Following FIWARE Smart Data Models Device specification.
      properties:
        "@context":
          type: array
          description: NGSI-LD context
          items:
            oneOf:
              - type: string
              - type: object
          example:
            - "https://smartdatamodels.org/context.jsonld"
            - sosa: "http://www.w3.org/ns/sosa/"
        id:
          type: string
          description: URN identifier
          example: "urn:ngsi-ld:Device:station-nguyenvancu"
        type:
          type: string
          enum: [Device]
        name:
          type: object
          properties:
            type:
              type: string
              enum: [Property]
            value:
              type: string
        location:
          type: object
          properties:
            type:
              type: string
              enum: [GeoProperty]
            value:
              type: object
              properties:
                type:
                  type: string
                  enum: [Point]
                coordinates:
                  type: array
                  description: "[longitude, latitude]"
                  items:
                    type: number
        deviceState:
          type: object
          properties:
            type:
              type: string
              enum: [Property]
            value:
              type: string
              enum: [active, inactive]
        deviceCategory:
          type: object
          properties:
            type:
              type: string
              enum: [Property]
            value:
              type: array
              items:
                type: string
              example: ["sensor"]
        controlledProperty:
          type: object
          properties:
            type:
              type: string
              enum: [Property]
            value:
              type: array
              items:
                type: string
              example: ["airPollution"]
    
    NgsiLdAirQuality:
      type: object
      description: NGSI-LD AirQualityObserved entity
      properties:
        "@context":
          type: array
          items:
            oneOf:
              - type: string
              - type: object
        id:
          type: string
        type:
          type: string
          enum: [AirQualityObserved]
        dateObserved:
          type: object
        location:
          type: object
        pm25:
          type: object
        pm10:
          type: object
        temperature:
          type: object
        relativeHumidity:
          type: object
    
    Station:
      type: object
      description: Station entity (internal format, not NGSI-LD)
      properties:
        stationId:
          type: string
        name:
          type: string
        latitude:
          type: number
        longitude:
          type: number
        type:
          type: string
        isActive:
          type: boolean
    
    ExternalSource:
      type: object
      properties:
        stationId:
          type: string
        sourceUrl:
          type: string
        intervalMinutes:
          type: integer
          default: 5
        latitude:
          type: number
        longitude:
          type: number
    
    ExternalMqttSource:
      type: object
      properties:
        stationId:
          type: string
        brokerHost:
          type: string
        brokerPort:
          type: integer
        topic:
          type: string
        username:
          type: string
        password:
          type: string
        latitude:
          type: number
        longitude:
          type: number
